name: PowerShell Lint (Public)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "Public/**/*.ps1"
      - "Public/**/*.psm1"
      - "Public/**/*.psd1"
      - "Scripts/Format-PowerShellScripts.ps1"
  push:
    branches: [main]
    paths:
      - "Public/**/*.ps1"
      - "Public/**/*.psm1"
      - "Public/**/*.psd1"
      - "Scripts/Format-PowerShellScripts.ps1"
      - ".github/workflows/lint.yml"

jobs:
  lint:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup PowerShell modules
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force
          Import-Module PSScriptAnalyzer -Force

      - name: Format-check using Scripts/Format-PowerShellScripts.ps1
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          pwsh -NoProfile -File .\Scripts\Format-PowerShellScripts.ps1

          # Fail if formatter produced any changes
          $changes = git status --porcelain
          if ($changes) {
            $changes
            git --no-pager diff
            throw "Formatting changes detected. Please run Scripts/Format-PowerShellScripts.ps1 locally and commit the results."
          }

      - name: PSScriptAnalyzer (Public scripts)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          $settingsPath = Join-Path $PWD "PSScriptAnalyzerSettings.psd1"

          $params = @{
            Path    = "Public"
            Recurse = $true
          }

          if (Test-Path $settingsPath) {
            $params.Settings = $settingsPath
          }

          $results = Invoke-ScriptAnalyzer @params

          if ($results) {
            $results | Sort-Object Severity, RuleName, ScriptName |
              Format-Table -AutoSize Severity, RuleName, ScriptName, Line, Message

            throw "PSScriptAnalyzer reported issues."
          }
